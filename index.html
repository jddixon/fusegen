<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>fusegen</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" type="text/css" href="css/main.css" />
  <link rel="stylesheet" type="text/css" href="css/normalize.css" />
  <link rel="stylesheet" type="text/css" href="css/ghp.css" />
</head>
<body>
<div class="content">
<h1>fusegen</h1>

<p>Tools for generating and monitoring a Linux
<a href="http://fuse.sourceforge.net">FUSE</a> user-space file system.</p>

<h2>fuseGen</h2>

<p>FuseGen is a Python 3 script which generates the basis of a FUSE file system
in the form
of a mixture of
<a href="http://en.wikipedia.org/wiki/GNU_build_system">Autotools</a>
configuration files and
<a href="http://en.wikipedia.org/wiki/ANSI_C">ANSI C</a>
source code.  The
C files constitute a <strong>pass-through</strong> FUSE file system.  This means that FUSE
operations are logged and statistics gathered, and then the commands are
passed through to the local file system for execution.</p>

<p>The resulting system can then be used as-is for studying FUSE or
generating statistics on the input/output patterns of particular software.
Alternatively FuseGen&rsquo;s python code can be customized to generate different
C code, or the generated C code can be customized.</p>

<h3>FuseGen Command Line</h3>

<pre><code>usage: fuseGen [-h] [-A ACPREREQ] [-D MYDATE] [-E EMAILADDR] [-I] [-f] [-j]
               [-P PKGNAME] [-T] [-v] [-V MYVERSION]

generate a minimal FUSE (file system in user space) package

optional arguments:
  -h, --help            show this help message and exit
  -A ACPREREQ, --acPrereq ACPREREQ
                        prerequisite autoconfig version number
  -D MYDATE, --myDate MYDATE
                        date in YYYY-MM-DD format
  -E EMAILADDR, --emailAddr EMAILADDR
                        contact email address
  -I, --instrumenting   generate instrumentation code
  -f, --force           if utility already exists, overwrite it
  -j, --justShow        show options and exit
  -P PKGNAME, --pkgName PKGNAME
                        utility package name
  -T, --testing         this is a test run
  -v, --verbose         be chatty
  -V MYVERSION, --myVersion MYVERSION
                        version in X.Y.Z format
</code></pre>

<p>This is the command line at the time of writing; when you unpack
fusegen you should type <code>fuseGen -h</code> to see the current set of
supported arguments.</p>

<h3>Typical FuseGen Command Line: genEm</h3>

<p>When fusegen is unpacked, the distribution directory contains a file
<code>genEm</code>.  As it stands this creates the <code>xxxfs</code> file system.  That is,
it writes a number of files to a subdirectory of your development
directory.</p>

<pre><code>cd ~/dev/py/fusegen
./fuseGen -fIvP xxxfs
</code></pre>

<p>In this case, the package name is <strong>xxxfs</strong> (because the follows the <strong>-P</strong>),
and that will be the name
of the development directory.  If the directory already exists, it is
overwritten (<strong>-f</strong>).  Instrumentation code will be generated (<strong>-I</strong>)</p>

<h3>File System Created</h3>

<p><code>genEm</code> creates a number of files and directories.   What you see below
is a snapshot taken shortly after initialization (in fact, after running
the <strong>build</strong> command but without the object files and executables
generated my <code>make</code>).</p>

<pre><code>/home/jdd/dev/c/xxxfs
├── aclocal.m4
├── AUTHORS
├── autogen.sh
├── autom4te.cache
├── bin
│   ├── blk-31-4k
│   ├── mountXXXFS
│   └── umountXXXFS
├── build
├── ChangeLog
├── CHANGES
├── config
├── config.guess
├── config.log
├── config.status
├── config.sub
├── configure
├── configure.ac
├── COPYING
├── COPYING.AUTOCONF.EXCEPTION
├── COPYING.GNUBL
├── COPYING.LIB
├── doc
├── examples
├── INSTALL
├── libtool
├── m4
├── Makefile
├── Makefile.am
├── Makefile.in
├── man
├── NEWS
├── README
├── README.licenses
├── scripts
├── src
│   ├── access.inc
│   ├── bmap.inc
│   ├── chmod.inc
│   ├── chown.inc
│   ├── config.h
│   ├── config.h.in
│   ├── create.inc
│   ├── destroy.inc
│   ├── fallocate.inc
│   ├── fgetattr.inc
│   ├── flock.inc
│   ├── flush.inc
│   ├── fsyncdir.inc
│   ├── fsync.inc
│   ├── ftruncate.inc
│   ├── fuse_common.h
│   ├── fuse.h
│   ├── fuse_opt.h
│   ├── fuse_version.h
│   ├── getattr.inc
│   ├── getxattr.inc
│   ├── init.inc
│   ├── link.inc
│   ├── listxattr.inc
│   ├── lock.inc
│   ├── main.inc
│   ├── Makefile
│   ├── Makefile.am
│   ├── Makefile.in
│   ├── mkdir.inc
│   ├── mknod.inc
│   ├── opcodes.h
│   ├── opendir.inc
│   ├── open.inc
│   ├── optable.inc
│   ├── readdir.inc
│   ├── read.inc
│   ├── readlink.inc
│   ├── releasedir.inc
│   ├── release.inc
│   ├── removexattr.inc
│   ├── rename.inc
│   ├── rmdir.inc
│   ├── setxattr.inc
│   ├── stamp-h1
│   ├── statfs.inc
│   ├── symlink.inc
│   ├── truncate.inc
│   ├── unlink.inc
│   ├── util.c
│   ├── utimens.inc
│   ├── write.inc
│   ├── xxxfs
│   ├── xxxfs.c
│   ├── xxxfs.h
├── tmp
│   └── bucket-20150316-150838
├── workdir
│   ├── mountPoint
│   └── rootdir
│       ├── foo
│       ├── job1.1.0
│       ├── job2.2.0
│       ├── job3.3.0
│       └── job4.4.0
└── xxxfs.log
</code></pre>

<p>For easy customization there is a <code>.inc</code> file for each FUSE command.</p>

<h3>The build Command</h3>

<p>The <code>build</code> command completes the creation of the file system.  It runs
<code>autogen.sh</code>, which installs many of the standard Autotools files, and
then creates the <code>configure</code> script from the instructions in <code>configure.ac</code>.
Finaly it runs make, which compiles the object files and then links the
file system, the <code>xxxfs</code> executable.</p>

<pre><code>./autogen.sh
./configure
make
</code></pre>

<p>It may be desirable to change the generated system to some degree.<br />
Usually limited changes are accomplished by editing <code>configure.ac</code>
and/or <code>Makefile.ac</code> and then rerunning build.  This will have no
effect on <code>src/*.inc</code> and in that sense is safe.</p>

<h3>bin/ Commands</h3>

<p>The <code>bin/</code> subdirectory contains scripts for</p>

<ul>
<li>mounting the file system (<code>mountXXXFS</code> in this case)</li>
<li>running a simple FIO benchmark (<code>blk-31-4k</code>)</li>
<li>and dismounting the file system (<code>umountXXXFS</code>)</li>
</ul>

<h2>Putting It All Together: Running an Application</h2>

<p>The script <code>blk-31-4k</code>, found in the default <code>bin/</code> directory, is used
to collect statistics on a short <strong>fio</strong> run.  FIO is an
<a href="https://github.com/axbose/fio">open source</a> tool
for measuring the performance of a file system.</p>

<pre><code>echo &quot;blk-31-4k: test size is being set to $1 MB&quot;
#
cd ~/dev/c/xxxfs
bin/mountXXXFS
cd workdir/mountPoint
fio --name=global --bs=4k --size=$1m    --rw=randrw --rwmixread=75  --name=job1 --name=job2 --name=job3 --name=job4
cd ../..
bin/umountXXXFS
</code></pre>

<p>This particular script runs four jobs simultaneously.  Each job reads
and/or writes the same amount of data to the disk.  On the command line
the script has a single argument, the number of megabytes to be read from
and/or written to the disk.  For this test the mount point and the root
directory are both subdirecties of <code>workdir</code>.  The script changes to the
directory above that, then mounts the FUSE file system (<code>bin/mountXXXFS</code>).
It then runs the FIO jobs in the <code>mountPoint</code> subdirectory.  When the FIO
jobs terminate, the script changes back to the distribution directory and
unmounts the file system.</p>

<p>Running this script has two major effects:</p>

<ul>
<li>it writes its log to the file <code>xxxfs.log</code></li>
<li>it writes run statistics to a file under <code>tmp/</code></li>
</ul>

<p>If full logging is turned on, the log file can be very large.</p>

<h2>FuseGen Statistics File</h2>

<p>The statistics file has a name like <code>bucket-20150316-150838</code>.  The first
set of numbers in the file name represents the date in <code>CCYYMMDD</code> format; the
second set is the start time of the run, local time, as <code>HHMMSS</code>.  We use
a 24-hour clock, so in this case the run started at 15:08:38, just
after 3 pm local time.</p>

<pre><code>typedef struct o_ {
    uint32_t    opSec;
    uint32_t    opNsec;             // may not exceed BILLION
    uint32_t    lateNsec;           // ns of latency; may not exceed BILLION
    unsigned    lateSec     :  7;   // sec of latency
    unsigned    count       : 17;   // bytes read or written; 128K max
    unsigned    opCode      :  8;
} __attribute__((aligned(16), packed)) opData_t;
</code></pre>

<p>Each call on the FUSE file system is recorded to the statistics file as
a 16-byte object laid out as specified above.</p>

<p>The time of the call is recorded as a 128-bit pair, <code>opSec</code> and
<code>opNsec</code>.  This is a Linux CLOCK_MONOTONIC time representing an absolute
elapsed time; it is generally <strong>not</strong> the same as the system&rsquo;s (guess at)
the local time.</p>

<p>When the system call is complete, the latency is calculated.  This has the
same 32-bit nanosecond part, but only 7 bits are reserved for the seconds
of latency.  That is, latencies greater than 128 seconds will not be recorded
correctly.</p>

<p>Finally 8 bits are reserved for the FUSE opcode.  There are currently
fewer than four dozen opcodes so this number of bits is likely to be
sufficient for some time.</p>

<h2>FuseDecode</h2>

<p>FuseDecode is a utility for converting FuseGen statistics files to a
human-readable format.</p>

<h3>FuseDecode Command Line</h3>

<pre><code>usage: fuseDecode [-h] [-D PATHTODATA] [-j] [-n HOWMANY] [-v]

parse a fuseGenned data file

optional arguments:
  -h, --help            show this help message and exit
  -D PATHTODATA, --pathToData PATHTODATA
                        path to data file
  -j, --justShow        show options and exit
  -n HOWMANY, --howMany HOWMANY
                        how many data points to decode
  -v, --verbose         be chatty
</code></pre>

<h3>Typical FuseDecode Output</h3>

<pre><code>==== op time === == latency == = byte = == opcode ==     = flags =
  sec   nanosec  sec  nanosec   count   op   name
369886 170431079  0     74955       0   29 init             
369886 170592946  0     91116       0    0 getattr          
369886 170601627  0     58834       0   25 opendir          P
369886 170728424  0     68768       0   26 readdir          
369886 170849263  0     60370       0    0 getattr          
369886 170851394  0     80361       0    0 getattr          P
369886 170937891  0     22188       0   31 access           
369886 170972000  0     52993       0    0 getattr          
369886 171057175  0     28741       0    0 getattr          
369886 171112174  0     21897       0    0 getattr          
369886 171181270  0     26367       0    0 getattr          
369886 171243684  0     22415       0    0 getattr          
369886 171301507  0     41395       0    0 getattr          
369886 171378102  0     24336       0    0 getattr          
369886 171483916  0     21530       0   27 releasedir       
369886 171505940  0     30953       0   25 opendir          
369886 171587944  0     47520       0   26 readdir          
369886 171748142  0     16430       0   27 releasedir       
369886 171768149  0     25347       0   25 opendir          
369886 171832503  0     46673       0   26 readdir          
369886 171986430  0     70618       0   27 releasedir       
369886 172007454  0     53362       0   25 opendir          P
369886 172099167  0     49953       0   26 readdir          
</code></pre>

<p>Output from a typical run of the <code>blk-31-4k</code> script is available
<a href="runData-20150316-135941.gz">here</a></p>

<h2>Licensing</h2>
<p><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />The material on this github.io website is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</p>
<p>Project software is licensed under an MIT license.
Follow the SOFTWARE LICENSE link below for more information on project software licensing.</p>  <div class="f">
    <hr />
    <div class="license">
      <p><a href="LICENSE.html">SOFTWARE LICENSE</a></p>
    </div>
    <div class="project">
      github <a href="https://github.com/jddixon/fusegen">      <img src="img/GitHub-Mark-32px.png" 
        alt="link to project"  
        style="display: inline-block; margin-left: 0 auto; margin-right: 0 auto">
       </a> project
    </div>
    <div class="logo" >
      <a href="http://www.xlattice.org">
      <img src="img/xlattice-2014.jpg" alt="the XLattice Project" style="float: right;" >
      </a>
    </div>
  </div>
</div>
</body>
</html>
